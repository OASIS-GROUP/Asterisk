; ==============================================================================
; DIALPLAN DE ASTERISK PARA AVR (Agent Voice Response)
; ==============================================================================
; Este archivo define el plan de marcación (dialplan) de Asterisk
; Maneja el enrutamiento de llamadas y la integración con AVR Core mediante AudioSocket
; ==============================================================================

; ------------------------------------------------------------------------------
; CONTEXTO AVR - Subrutina principal de procesamiento de llamadas
; ------------------------------------------------------------------------------
; Esta subrutina se encarga de:
; 1. Generar un UUID único para cada llamada
; 2. Capturar y guardar el Caller ID
; 3. Conectar la llamada con AVR Core mediante AudioSocket
[avr]
exten => s,1,Answer()                    ; 1. Contestar la llamada
 same => n,Ringing()                     ; 2. Enviar señal de timbre (por compatibilidad)
 same => n,Wait(1)                       ; 3. Esperar 1 segundo para estabilizar la conexión
 same => n,Set(UUID=${SHELL(uuidgen | tr -d '\n')}) ; 4. Generar UUID único para esta llamada
 same => n,Set(CALLER_NUM=${CALLERID(num)})        ; 5. Extraer número del llamante
 same => n,Set(CALLER_NAME=${CALLERID(name)})      ; 6. Extraer nombre del llamante
 
 ; === SECCIÓN DE DEBUG: Imprimir información del Caller ID ===
 same => n,NoOp(=== CALLER ID DEBUG ===)
 same => n,NoOp(CALLERID(all): ${CALLERID(all)})       ; Caller ID completo
 same => n,NoOp(CALLERID(num): ${CALLER_NUM})          ; Número del llamante
 same => n,NoOp(CALLERID(name): ${CALLER_NAME})        ; Nombre del llamante
 same => n,NoOp(CALLERID(ani): ${CALLERID(ani)})       ; ANI (Automatic Number Identification)
 same => n,NoOp(CALLERID(dnid): ${CALLERID(dnid)})     ; DNID (Dialed Number Identification)
 same => n,NoOp(CALLERID(rdnis): ${CALLERID(rdnis)})   ; RDNIS (Redirecting Number)
 same => n,NoOp(CHANNEL: ${CHANNEL})                   ; Nombre del canal
 same => n,NoOp(EXTEN: ${EXTEN})                       ; Extensión marcada
 same => n,NoOp(=====================)
 
 ; === CONFIGURACIÓN DE TIMEOUTS ===
 same => n,Set(TIMEOUT(absolute)=600)   ; 7. Timeout absoluto de 600 segundos (10 minutos)
 
 ; === GUARDAR CALLER ID EN ARCHIVO TEMPORAL ===
 same => n,Set(RESULT=${SHELL(/etc/asterisk/save-caller-id.sh ${UUID} ${CALLER_NUM})})
 ; 8. Ejecutar script que guarda el Caller ID en /tmp/callerid-{UUID}.txt
 ;    Esto permite que el proxy LLM acceda al número del llamante
 
 ; === CONECTAR CON AVR CORE MEDIANTE AUDIOSOCKET ===
 same => n,Dial(AudioSocket/${ARG1}/${UUID},120,gKk)
 ; 9. Establecer conexión AudioSocket con AVR Core
 ;    - ${ARG1}: Dirección del servidor AVR Core (ej: avr-core:5001)
 ;    - ${UUID}: ID único de la conversación
 ;    - 120: Timeout de marcación (120 segundos)
 ;    - g: Continuar en el dialplan después del Dial
 ;    - K: Permitir que el llamado ejecute transferencias
 ;    - k: Permitir que el llamante ejecute transferencias
 
 same => n,NoOp(Dial finished with status: ${DIALSTATUS}) ; 10. Log del estado final
 same => n,Hangup()                      ; 11. Colgar la llamada

; === MANEJADOR DE COLGADO ===
; Se ejecuta automáticamente cuando la llamada termina
exten => h,1,NoOp(Hangup handler - cleaning up call)  ; Log de inicio de limpieza
 same => n,NoOp(Channel: ${CHANNEL})                   ; Log del canal
 same => n,NoOp(Dialstatus: ${DIALSTATUS})            ; Log del estado de marcación
 same => n,Return()                                    ; Retornar al contexto anterior

; ------------------------------------------------------------------------------
; CONTEXTO FROM-PSTN - Llamadas entrantes desde la red telefónica (PSTN)
; ------------------------------------------------------------------------------
; Este contexto maneja llamadas entrantes desde el gateway HT813
; que conecta líneas telefónicas tradicionales con el sistema VoIP

; === EXTENSIÓN DEFAULT (s) ===
; Se ejecuta cuando no se puede determinar la extensión marcada
[from-pstn]
exten => s,1,NoOp(Llamada entrante desde HT813 recibida)
 same => n,NoOp(=== FROM-PSTN CALLER ID DEBUG ===)
 same => n,NoOp(CALLERID(all): ${CALLERID(all)})
 same => n,NoOp(CALLERID(num): ${CALLERID(num)})
 same => n,NoOp(CALLERID(name): ${CALLERID(name)})
 same => n,NoOp(CALLERID(ani): ${CALLERID(ani)})
 same => n,NoOp(CALLERID(dnid): ${CALLERID(dnid)})
 same => n,NoOp(CALLERID(rdnis): ${CALLERID(rdnis)})
 same => n,NoOp(CHANNEL: ${CHANNEL})
 same => n,NoOp(EXTEN: ${EXTEN})
 same => n,NoOp(CONNECTEDLINE(all): ${CONNECTEDLINE(all)})
 same => n,NoOp(REDIRECTING(from-num): ${REDIRECTING(from-num)})
 same => n,NoOp(===================================)
 same => n,GoSub(avr,s,1(avr-core:5001))  ; Llamar a la subrutina AVR con el servidor core

; === EXTENSIÓN ESPECÍFICA HT813 ===
; Para llamadas dirigidas explícitamente a 'ht813'
exten => ht813,1,NoOp(Llamada entrante desde HT813 recibida)
 same => n,NoOp(=== FROM-PSTN CALLER ID DEBUG (ht813) ===)
 same => n,NoOp(CALLERID(all): ${CALLERID(all)})
 same => n,NoOp(CALLERID(num): ${CALLERID(num)})
 same => n,NoOp(CALLERID(name): ${CALLERID(name)})
 same => n,NoOp(===================================)
 same => n,GoSub(avr,s,1(avr-core:5001))  ; Llamar a la subrutina AVR

; === PATRÓN COMODÍN (Cualquier número) ===
; _X. = Coincide con cualquier número de uno o más dígitos
; Útil para capturar todas las llamadas con diferentes números marcados
exten => _X.,1,NoOp(Llamada entrante desde HT813 - cualquier numero)
 same => n,NoOp(=== FROM-PSTN CALLER ID DEBUG (numero: ${EXTEN}) ===)
 same => n,NoOp(CALLERID(all): ${CALLERID(all)})
 same => n,NoOp(CALLERID(num): ${CALLERID(num)})
 same => n,NoOp(CALLERID(name): ${CALLERID(name)})
 same => n,NoOp(EXTEN recibido: ${EXTEN})
 same => n,NoOp(===================================)
 same => n,GoSub(avr,s,1(avr-core:5001))  ; Llamar a la subrutina AVR

; ------------------------------------------------------------------------------
; CONTEXTO DEMO - Extensiones de prueba
; ------------------------------------------------------------------------------
; Extensiones internas para realizar llamadas de prueba
[demo]

; === EXTENSIÓN POR DEFECTO ===
; Si llamas sin marcar número, automáticamente conecta con AVR
exten => s,1,NoOp(Llamada interna sin extension - redirigiendo a AVR)
 same => n,GoSub(avr,s,1(avr-core:5001))

; === EXTENSIONES DE PRUEBA ===
exten => 5001,1,GoSub(avr,s,1(avr-core:5001))           ; Llamar a AVR Core en contenedor Docker
exten => 5002,1,GoSub(avr,s,1(host.docker.internal:5001)) ; Llamar a AVR Core en host local (desarrollo)
