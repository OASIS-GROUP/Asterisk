; ==============================================================================
; CONFIGURACIÓN PJSIP DE ASTERISK PARA AVR (Agent Voice Response)
; ==============================================================================
; Este archivo configura el stack PJSIP de Asterisk para manejar llamadas SIP
; Incluye configuración para endpoints internos y gateway externo (HT813)
; ==============================================================================

; ------------------------------------------------------------------------------
; TRANSPORTE TCP
; ------------------------------------------------------------------------------
; Configuración del transporte TCP para comunicación SIP
[transport-tcp]
type=transport                          ; Tipo: Transporte SIP
protocol=tcp                            ; Protocolo: TCP (más confiable que UDP)
bind=0.0.0.0:5060                       ; Escuchar en todas las interfaces, puerto 5060 (SIP estándar)

; === CONFIGURACIÓN DE RED ===
; PRODUCCIÓN: IP pública para endpoint 1000 y HT813 (ACTIVO)
external_media_address=35.226.73.203    ; IP pública del servidor
external_signaling_address=35.226.73.203 ; IP pública para señalización
external_signaling_port=5060            ; Puerto SIP externo

; DESARROLLO LOCAL: Descomentar para usar IP local (comentar las de arriba)
; (Solo para pruebas locales en red 192.168.1.x)
;external_media_address=192.168.1.12    ; IP local del Mac para desarrollo
;external_signaling_address=192.168.1.12 ; IP local del Mac para desarrollo
;external_signaling_port=5060           ; Puerto SIP externo

local_net=192.168.1.0/24                ; Red local privada (para detección de NAT)
local_net=172.20.0.0/24                 ; Red Docker (para comunicación entre contenedores)

; ------------------------------------------------------------------------------
; PLANTILLA DE ENDPOINT
; ------------------------------------------------------------------------------
; Plantilla base con configuración común para todos los endpoints
; El símbolo (!) indica que es una plantilla que puede ser heredada
[endpoint-template](!)
type=endpoint                           ; Tipo: Endpoint SIP
transport=transport-tcp                 ; Usar el transporte TCP definido arriba
context=demo                            ; Contexto de dialplan por defecto
disallow=all                            ; Deshabilitar todos los codecs primero
allow=gsm                               ; Permitir codec GSM (compresión, bueno para telefonía)
allow=ulaw                              ; Permitir codec ulaw (sin compresión, calidad)
direct_media=no                         ; Forzar que el media pase por Asterisk (no directo)
force_rport=no                          ; No forzar rport (para NAT)
rewrite_contact=yes                     ; Reescribir contacto para atravesar NAT
rtp_symmetric=yes                       ; Usar RTP simétrico (importante para NAT traversal)
rtp_timeout=60                          ; Timeout de inactividad RTP: 60 segundos
rtp_timeout_hold=300                    ; Timeout RTP en espera: 5 minutos
rtp_keepalive=15                        ; Enviar paquetes keepalive cada 15 segundos
timers=yes                              ; Habilitar timers de sesión SIP
timers_min_se=90                        ; Tiempo mínimo de expiración de sesión: 90 segundos
timers_sess_expires=1800                ; Tiempo de expiración de sesión: 30 minutos

; ------------------------------------------------------------------------------
; ENDPOINT INTERNO 1000
; ------------------------------------------------------------------------------
; Endpoint de prueba interno para testing y llamadas de demostración
[1000](endpoint-template)               ; Heredar configuración de endpoint-template
auth=1000                               ; Usar autenticación definida en [1000] auth
aors=1000                               ; Usar AOR (Address of Record) definido abajo

; Autenticación para endpoint 1000
[1000]
type=auth                               ; Tipo: Autenticación
auth_type=userpass                      ; Tipo de auth: usuario/contraseña
password=1000                           ; Contraseña (cambiar en producción)
username=1000                           ; Nombre de usuario

; AOR (Address of Record) para endpoint 1000
[1000]
type=aor                                ; Tipo: Address of Record
max_contacts=10                         ; Máximo 10 dispositivos registrados simultáneamente

; ------------------------------------------------------------------------------
; GATEWAY GRANDSTREAM HT813
; ------------------------------------------------------------------------------
; Configuración para el adaptador analógico Grandstream HT813
; Este dispositivo convierte líneas telefónicas tradicionales a SIP
;
; CONFIGURACIÓN DEL HT813 (PRODUCCIÓN):
; - Servidor SIP: 35.226.73.203
; - Puerto: 5060
; - Usuario: ht813
; - Contraseña: ht813password
; - Protocolo: TCP
; - Se conecta desde IP: 157.100.110.71
[ht813]
type=endpoint                           ; Tipo: Endpoint SIP
transport=transport-tcp                 ; Usar transporte TCP
context=from-pstn                       ; Contexto especial para llamadas entrantes PSTN
disallow=all                            ; Deshabilitar todos los codecs primero
allow=gsm                               ; Permitir GSM (compresión)
allow=ulaw                              ; Permitir ulaw (calidad)
direct_media=no                         ; Media debe pasar por Asterisk
force_rport=no                          ; No forzar rport
rewrite_contact=yes                     ; Reescribir contacto para NAT
rtp_symmetric=yes                       ; RTP simétrico para NAT
rtp_timeout=60                          ; Timeout RTP: 60 segundos
rtp_timeout_hold=300                    ; Timeout en espera: 5 minutos
rtp_keepalive=15                        ; Keepalive cada 15 segundos
timers=yes                              ; Habilitar timers de sesión
timers_min_se=90                        ; Min sesión: 90 segundos
timers_sess_expires=1800                ; Expiración sesión: 30 minutos
auth=ht813                              ; Usar autenticación ht813
aors=ht813                              ; Usar AOR ht813
identify_by=ip,auth_username            ; Identificar por IP y nombre de usuario

; Configuración de Caller ID - Importante para identificar llamantes
trust_id_inbound=yes                    ; Confiar en el Caller ID entrante del HT813
trust_id_outbound=yes                   ; Confiar en el Caller ID saliente al HT813
send_pai=yes                            ; Enviar P-Asserted-Identity header
send_rpid=yes                           ; Enviar Remote-Party-ID header

; Autenticación para HT813
[ht813]
type=auth                               ; Tipo: Autenticación
auth_type=userpass                      ; Tipo: usuario/contraseña
password=ht813password                  ; Contraseña del HT813 (debe coincidir con config del dispositivo)
username=ht813                          ; Usuario del HT813

; AOR para HT813
[ht813]
type=aor                                ; Tipo: Address of Record
max_contacts=5                          ; Máximo 5 registros simultáneos
remove_existing=yes                     ; Remover registros existentes al registrar nuevo
qualify_frequency=60                    ; Verificar disponibilidad cada 60 segundos

; Identificación por IP para HT813
; NOTA: Descomentar la IP según ubicación del HT813
[ht813]
type=identify                           ; Tipo: Identificación
endpoint=ht813                          ; Asociar con endpoint ht813

; Para HT813 remoto (conectado desde internet):
match=157.100.110.71                    ; IP pública del HT813 remoto
match=181.233.51.186

; Para HT813 en red local (descomentar si aplica):
;match=192.168.1.0/24                   ; Permitir cualquier IP de la red local